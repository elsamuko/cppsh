#!/bin/bash

SCRIPT="$1"
TEMP="/tmp/$1"
BIN="/tmp/${1%.cpp}.exe"
HELPER="/tmp/compile.bat"
LOG="/tmp/error.log"

function create_helper {
	if [ -f "$HELPER" ]; then
		rm "$HELPER"
	fi
	echo -e "@echo off\r\ncall vcvars32.bat\r\ncl /EHsc %*" > "$HELPER"
	chmod +x "$HELPER"
}

function please_remove {
	if [ -f "$1" ]; then
		rm "$1"
	fi
}


# cleanup
please_remove "$BIN"
please_remove "$TEMP"
please_remove "$HELPER"
please_remove "$LOG"


# remove interpreter header
echo "// auto-generated" > "$TEMP"
tail -n +2 "$SCRIPT" >> "$TEMP"


# compile
case $(uname) in
	Linux)
		g++ -std=c++11 "$TEMP" -o "$BIN" > "$LOG"
		;;
	Darwin)
		clang++ -std=c++11 -stdlib=libc++ "$TEMP" -o "$BIN" > "$LOG"
		;;
	CYGWIN*)
		WTEMP=$(cygpath -w "$TEMP")
		WBIN=$(cygpath -w "$BIN")
		create_helper
		"$HELPER" "$WTEMP" /Fe"$WBIN" 2> /dev/null 1> "$LOG"
 		;;
	*)
		echo "Error: Unknown OS"
		;;
esac


#execute
if [ -f "$BIN" ]; then
    "$BIN"
else
    cat "$LOG"
fi




