#!/bin/bash

if [ $# -lt 1 ]
then
  echo "Use $0 as interpreter only."
  exit 1
fi

BASE=$(basename "$1")
TEMP="/tmp/$BASE"
BIN="/tmp/${BASE%.cpp}.exe"
HELPER="/tmp/compile.bat"
LOG="/tmp/error.log"

function create_helper {
    echo -e '@echo off\r\ncall "%VS110COMNTOOLS%..\\..\\VC\\bin\\vcvars32.bat"\r\ncl /EHsc %*' > "$HELPER"
    chmod +x "$HELPER"
}

function please_remove {
    if [ -f "$1" ]; then
        rm "$1"
    fi
}


# cleanup
please_remove "$BIN"
please_remove "$TEMP"
please_remove "$HELPER"
please_remove "$LOG"


# remove interpreter header
echo "// auto-generated" > "$TEMP"
tail -n +2 "$1" >> "$TEMP"


# compile
case $(uname) in
    Linux)
        g++ -std=c++11 "$TEMP" -o "$BIN" > "$LOG"
        ;;
    Darwin)
        clang++ -std=c++11 -stdlib=libc++ "$TEMP" -o "$BIN" > "$LOG"
        ;;
    CYGWIN*)
        WTEMP=$(cygpath -w "$TEMP")
        WBIN=$(cygpath -w "$BIN")
        create_helper
        "$HELPER" "$WTEMP" /Fe"$WBIN" 2> /dev/null 1> "$LOG"
         ;;
    *)
        echo "Error: Unknown OS."
        ;;
esac


#execute
if [ -f "$BIN" ]; then
    shift # removes first argument
    "$BIN" "$@"
else
    cat "$LOG"
fi




